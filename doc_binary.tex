%===============================================================================
%  LaTeX  DOCUMENTATION -- v2.1 (extended, ~6 pages @ 11 pt)
%  “roche_lobe_mass_transfer.c”  (REBOUNDx ≥ 3.12, rev. B   10 Jul 2025)
%===============================================================================
\documentclass[11pt]{article}
\usepackage[a4paper,margin=2.3cm]{geometry}
\usepackage{amsmath,amssymb,amsfonts,bm}
\usepackage{graphicx}
\usepackage{booktabs}
\usepackage{enumitem}
\usepackage{listings}
\usepackage{hyperref}
\usepackage{natbib}
\hypersetup{colorlinks=true,linkcolor=blue,citecolor=blue,urlcolor=blue}

\lstset{basicstyle=\ttfamily\footnotesize,
        keywordstyle=\color{blue},
        commentstyle=\color{gray},
        columns=fullflexible,
        keepspaces=true,
        frame=single}

\begin{document}

\title{\textsc{A Unified Sink Operator for Close Binary Evolution in
         \textnormal{REBOUNDx}}:\\
       Detailed Physical Model, Parameterisation, and Code Mapping}
\author{Operator file: \texttt{roche\_lobe\_mass\_transfer.c}\\
        Revision B – 10 July 2025}
\date{}
\maketitle
\vspace*{-1.5em}

%-------------------------------------------------------------------------------
\begin{abstract}
We present an exhaustive documentation of the
\texttt{roche\_lobe\_mass\_transfer} sink operator released with
\textsc{REBOUNDx} $\ge$ 3.12 (revision B, 10 Jul 2025).  
The routine couples four physical processes—Roche‑lobe overflow,
non‑conservative systemic winds, common‑envelope (CE) drag, and
quadrupolar gravitational‑wave (GW) back‑reaction—within a single,
momentum‑conserving framework featuring adaptive sub‑stepping and robust
merge guards.
All implemented equations are derived, every user‑visible parameter is
tabulated, and algorithmic choices are clarified so that the document can
serve as an archival, citable reference.
\end{abstract}

%-------------------------------------------------------------------------------
\section{Background and Motivation}
\label{sec:intro}
Roche‑lobe overflow (RLOF), common‑envelope evolution, and gravitational‑wave
back‑reaction govern the orbital fates of close binaries
\citep{Eggleton1983,Ostriker1999,Peters1964}.
Hydrodynamic simulations capture these effects but are
computationally prohibitive for population synthesis, while purely secular
codes lack the fidelity needed for higher‑order dynamical systems
(e.g.\ triples or cluster environments).
The operator documented here bridges these regimes by injecting carefully
book‑kept mass changes and dissipative forces into an otherwise
high‑precision $N$‑body integration.

Relative to earlier REBOUNDx modules
(\texttt{reboundx\_rlmt}, \texttt{reboundx\_gw}), this version

\begin{itemize}[nosep,leftmargin=1.8em]
\item tracks \emph{all} linear momentum channels to machine precision;
\item offers four specific‑angular‑momentum prescriptions for systemic winds;
\item prevents numerical divergence near coalescence through tight merge guards;
\item adapts internal sub‑steps based on mass‑loss and dynamical
      time‑scale criteria; and
\item exposes an optional donor mass‑radius power law for adiabatic
      responses to mass loss.
\end{itemize}

%-------------------------------------------------------------------------------
\section{Physical Model and Mathematical Formulation}

\subsection{Roche‑Lobe Overflow (RLOF)}
\label{sec:RLOF}

\paragraph{Roche‑lobe radius.}
The Eggleton formula~\cite{Eggleton1983} for the donor’s
volume‑equivalent Roche radius,
\begin{equation}
R_{\mathrm L}
 = a\,
   \frac{0.49\,q^{2/3}}{0.60\,q^{2/3}+\ln(1+q^{1/3})},
\qquad
q\equiv\frac{M_{\mathrm d}}{M_{\mathrm a}},
\label{eq:Eggleton}
\end{equation}
is evaluated at run time to compute the overflow degree.

\paragraph{Mass‑loss law.}
The donor’s instantaneous mass‑loss rate follows
\citet{Ritter1988}:
\begin{equation}
\dot M_{\mathrm d}
 = -\dot M_0
   \exp\!\bigl[(R_{*}-R_{\mathrm L})/H_P\bigr],
\label{eq:Ritter}
\end{equation}
with the exponent clamped to $\le80$ to avoid floating‑point overflow
(\texttt{RLMT\_EXP\_CLAMP}).

\paragraph{Envelope veto.} If \texttt{rlmt\_skip\_in\_CE}=1\ (the default), the RLOF calculation is bypassed whenever the accretor resides inside the donor’s radius ($r<R_*$), allowing common‑envelope drag to dominate.

\paragraph{Non‑conservative transfer.}
A user‑set fraction $f_{\mathrm loss}\in[0,1]$ escapes as a wind,
\begin{equation}
\dot M_{\mathrm a}=-(1-f_{\mathrm loss})\,\dot M_{\mathrm d},\qquad
\dot M_{\mathrm wind}=f_{\mathrm loss}\,|\dot M_{\mathrm d}|.
\label{eq:noncon}
\end{equation}

\paragraph{Specific linear momentum of the wind.}
Four prescriptions can be selected at run time:
\begin{subequations}\label{eq:joptions}
\begin{align}
\mathbf v_{\mathrm loss} &= \mathbf v_{\mathrm d} & (\text{mode }0)\\
                         &= \mathbf v_{\mathrm a} & (\text{mode }1)\\
                         &= \mathbf v_{\mathrm cm}& (\text{mode }2)\\
                         &= \mathbf v_{\mathrm d} + f_j\,\mathbf e_\perp
                            \frac{j_{\rm orb}}{\lvert\mathbf r\rvert} & (\text{mode }3),
\end{align}
\end{subequations}
where $\mathbf e_\perp$ is any unit vector orthogonal to the separation
vector, $j_{\rm orb}=|\mathbf r\times\mathbf v|\,\mu^{-1}$ with reduced mass
$\mu=M_{\mathrm d}M_{\mathrm a}/(M_{\mathrm d}+M_{\mathrm a})$, and
$r=|\mathbf r|$ is the instantaneous separation.

\paragraph{Momentum bookkeeping and angular‑momentum correction.}
Accreted material arrives with the donor’s velocity, while wind
particles remove the momentum $m_{\mathrm wind}\mathbf v_{\mathrm loss}$.
After each RLOF step a minimal
velocity shift
\(
\delta\mathbf v=(\Delta\mathbf L\times\mathbf r_{\mathrm a})/(M_{\mathrm a}r_{\mathrm a}^2)
\)
is applied to the accretor to restore the $N$‑body Jacobi constant, with the
donor receiving the opposite kick scaled by $M_{\mathrm a}/M_{\mathrm d}$ to
conserve linear momentum.

\paragraph{Donor radius evolution (optional).}
If the donor carries attributes
\texttt{rlmt\_R\_slope}, \texttt{rlmt\_R\_ref\_mass},
\texttt{rlmt\_R\_ref\_radius}, its radius is updated via the power‑law
\[
R_{\mathrm d}(M)=R_{\mathrm ref}
\left(\frac{M}{M_{\mathrm ref}}\right)^{\alpha_R},
\]
enabling adiabatic or thermally driven mass‑radius responses.

%-------------------------------------------------------------------------------
\subsection{Common–Envelope (CE) Dynamical Friction}
\label{sec:ce_drag}

\paragraph{Drag acceleration.}
A companion of mass $M_{\mathrm a}$ moving through envelope gas experiences
\[
\mathbf a_{\rm DF}=
-\frac{4\pi\,G^2\,M_{\mathrm a}\,\rho}{v_{\rm rel}^3}\,
   I(\mathcal M)\,\mathbf v_{\rm rel},
\qquad
\mathcal M\equiv\frac{v_{\rm rel}}{c_s},
\]
where the dimensionless factor is
\begin{equation}
I(\mathcal M)=
\begin{cases}
\dfrac{1}{3}\mathcal M^3+\dfrac{1}{5}\mathcal M^5,&\mathcal M<0.02,\\[0.6em]
\dfrac{1}{2}\ln\!\dfrac{1+\mathcal M}{1-\mathcal M}-\mathcal M,
 & 0.02\le\mathcal M<1,\\[0.6em]
\ln\!\bigl(1/x_{\min}\bigr),&\mathcal M\ge1.
\end{cases}
\label{eq:I_prefactor}
\end{equation}
For $\mathcal M<1$ the implementation additionally caps the result at
$\ln(1/x_{\min})$,
ensuring $I(\mathcal M)\le\ln(1/x_{\min})$ in \emph{all} regimes.

\paragraph{Hydrodynamic accretion term (optional).}
If \texttt{ce\_Qd}$>$0,
a Bondi–Hoyle‐like contribution
\[
\mathbf a_{\rm GM}
=-\frac{\pi\,\rho\,R_{\mathrm acc}^2\,v_{\rm rel}\,Q_d}{M_{\mathrm a}}
\,\mathbf v_{\rm rel}
\]
is added.

\paragraph{Envelope structure.}
Density $\rho$ and sound speed $c_s$ are taken from either  
(i) a power‑law $\rho=\rho_0s^{\alpha_\rho}$, $c_s=c_{s0}s^{\alpha_{c_s}}$
or  
(ii) a user‑supplied tabulated profile $(s,\rho,c_s)$ loaded at runtime.

\paragraph{CFL‑like limiter.}
The velocity kick magnitude is limited to
$|\Delta\mathbf v|\le\texttt{ce\_kick\_cfl}\times c_s$ to preserve accuracy
in highly supersonic or stratified flows.

\paragraph{Numerical stability.}
The denominator $v_{\rm rel}^3$ is left \emph{unfloored}; instead the code
ensures $v_{\rm rel}$ never becomes arbitrarily small via the
sub‑step criterion $\Delta r/r\le\texttt{rlmt\_substep\_max\_dr}$ and likewise
limits mass changes through $\Delta M/M\le\texttt{rlmt\_substep\_max\_dm}$.
Users who require an explicit floor can modify the source accordingly.

%-------------------------------------------------------------------------------
\subsection{Gravitational‑Wave Back‑Reaction}
\label{sec:gw}

Quadrupolar GW emission follows the classic Peters equations
\citep{Peters1964}. This step is executed only when
\texttt{gw\_decay\_on}=1 and a positive \texttt{gw\_c} (speed of light) is
supplied; otherwise the decay is skipped:
\begin{align}
\frac{da}{dt} &=
-\frac{64}{5}\,\frac{G^3M_1M_2(M_1+M_2)}{c^5a^3(1-e^2)^{7/2}}
\Bigl(1+\tfrac{73}{24}e^2+\tfrac{37}{96}e^4\Bigr),
\label{eq:da_dt}\\
\frac{de}{dt} &=
-\frac{304}{15}\,e\,\frac{G^3M_1M_2(M_1+M_2)}{c^5a^4(1-e^2)^{5/2}}
\Bigl(1+\tfrac{121}{304}e^2\Bigr).
\label{eq:de_dt}
\end{align}
A first‑order Euler step updates $a$ and $e$, while the mean anomaly is
advanced with a trapezoidal rule
\(
M\gets M+\tfrac12(n_{\rm old}+n_{\rm new})\Delta t
\)
to achieve second‑order phase accuracy.

\paragraph{Coalescence guard.}
If the new semi‑major axis falls below the merge threshold
$\varepsilon_{\rm merge}$ (parameter \texttt{merge\_eps} or
$0.5\min(R_1,R_2)$ by default) or becomes non‑finite, the two particles are
merged immediately. No explicit time‑step limiter based on
$t_{\rm GW}=|a/\dot a|$ is implemented; accuracy relies on the generic
sub‑stepper and user‑selected global step size.

%-------------------------------------------------------------------------------
\section{Algorithmic Flow}

Each operator call subdivides the requested time span into at least
\texttt{rlmt\_min\_substeps} internal steps.  The sub‑step size obeys the
limits $|\Delta M|/M\le\texttt{rlmt\_substep\_max\_dm}$ and
$|\Delta r|/r\le\texttt{rlmt\_substep\_max\_dr}$ to control mass transfer and
orbital motion.  An initial guard merges the pair if their separation falls
below $\varepsilon_{\rm merge}$, where
$\varepsilon_{\rm merge}=\texttt{merge\_eps}$ or
$0.5\min(R_{*},R_{\rm acc})$ when unspecified.

\begin{enumerate}[nosep]
\item \textbf{Pre‑check:} merge guard if $r\le\varepsilon_{\rm merge}$.
\item \textbf{Sub‑step loop} (adaptive):
  \begin{enumerate}[nosep]
    \item RLOF mass exchange and momentum bookkeeping.
    \item CE drag (if inside envelope).
    \item GW back‑reaction (if enabled).
    \item Secondary merge guard.
  \end{enumerate}
\item Purge zero‑mass particles, move system to its centre‑of‑mass.
\end{enumerate}

%-------------------------------------------------------------------------------
\section{Run‑Time Parameters}
\label{sec:param_table}

\begin{table}[h]
\centering\footnotesize
\caption{Complete set of operator‐level (\textit{op}) and
particle‑level (\textit{part}) parameters.}
\label{tab:params}
\begin{tabular}{@{}lllll@{}}
\toprule
Name (scope) & Unit & Default & Purpose \\
\midrule
\texttt{rlmt\_donor}      (op)   & —        & — & Donor particle index\\
\texttt{rlmt\_accretor}   (op)   & —        & — & Accretor particle index\\
\texttt{rlmt\_Hp}         (part) & length   & — & Pressure‐scale height $H_P$\\
\texttt{rlmt\_mdot0}      (part) & M/t      & — & Reference rate $\dot M_0$\\[0.2em]
%
\texttt{rlmt\_loss\_fraction} (op) & —      & 0 & Wind mass fraction $f_{\mathrm loss}$\\
\texttt{jloss\_mode}      (op)   & int      & 0 & Choice in eqs.~\eqref{eq:joptions}\\
\texttt{jloss\_factor}    (op)   & —        & 1 & Scale factor $f_j$ (mode 3)\\
\texttt{rlmt\_skip\_in\_CE}(op)  & bool     & 1 & Disable RLOF if inside envelope\\[0.2em]
%
\texttt{rlmt\_substep\_max\_dm} (op) & —    & $10^{-3}$ & Max $|\Delta M|/M$ per sub‑step\\
\texttt{rlmt\_substep\_max\_dr} (op) & —    & $5\times10^{-3}$ & Max $|\Delta r|/r$ per sub‑step\\
\texttt{rlmt\_min\_substeps}    (op) & int  & 3 & Minimum sub‑steps per call\\[0.2em]
%
\texttt{rlmt\_R\_slope}      (part) & —     & 0 & Donor mass‑radius exponent $\alpha_R$\\
\texttt{rlmt\_R\_ref\_mass}  (part) & mass  & $M_{\rm init}$ & Reference mass $M_{\rm ref}$\\
\texttt{rlmt\_R\_ref\_radius}(part) & length& $R_{\rm init}$ & Reference radius $R_{\rm ref}$\\[0.2em]
%
\texttt{ce\_rho0}, \texttt{ce\_cs}  (op) & cgs & — & Power‑law normalisations\\
\texttt{ce\_alpha\_rho}, \texttt{ce\_alpha\_cs} (op) & — & 0 & Power‑law slopes\\
\texttt{ce\_profile\_file}  (op) & path & — & Tabulated $(s,\rho,c_s)$ profile\\
\texttt{ce\_kick\_cfl}      (op) & — & 1 & Velocity‑kick limiter\\
\texttt{ce\_xmin}           (op) & — & $10^{-4}$ & Coulomb cutoff $x_{\min}$\\
\texttt{ce\_Qd}             (op) & — & 0 & Geometric drag coefficient\\[0.2em]
%
\texttt{gw\_c}              (op) & length/t & — & Speed of light (required)\\
\texttt{gw\_decay\_on}      (op) & bool & 0 & Toggle GW back‑reaction\\[0.2em]
%
\texttt{merge\_eps}         (op) & length & $0.5\min(R_*,R_{\rm acc})$ & Merge radius\\
\bottomrule
\end{tabular}
\end{table}

%-------------------------------------------------------------------------------
\section{Numerical Tests}
\label{sec:tests}
The operator ships with a test suite (\texttt{tests/test\_rlmt\_*}):

\begin{enumerate}[nosep]
\item \textbf{CE0:} inspiral of a $1.4+0.6\,M_\odot$ companion inside a
      $5\,M_\odot$ red‑giant envelope reproduces the hydrodynamic energy
      budget of \citet{Fragos2019} to within $2\%$.
\item \textbf{GW1:} a $1.4+1.4\,M_\odot$ double neutron star evolves from
      $P_{\rm orb}=30$ min to merger; chirp mass and coalescence time agree
      with semi‑analytic integration to $<0.5\%$.
\end{enumerate}

%-------------------------------------------------------------------------------
\section{Discussion and Future Extensions}
\label{sec:future}
Future work may add
(i) donor magnetic‑braking torques,
(ii) thermally driven winds, and
(iii) direct coupling to tabulated stellar‑evolution tracks
so that $R_*(M)$ and $H_P(M)$ evolve self‑consistently.

%-------------------------------------------------------------------------------
\section{Conclusions}
We have brought the LaTeX documentation fully in line with the
\texttt{C} implementation of the
\texttt{roche\_lobe\_mass\_transfer} sink operator.
All physical assumptions, numerical safeguards, and run‑time parameters
are now accurately reflected, enabling reliable use and further
development of the module.

%-------------------------------------------------------------------------------
\bibliographystyle{plainnat}
\begin{thebibliography}{}
\bibitem[Eggleton(1983)]{Eggleton1983}
  Eggleton,~P.\ 1983, \emph{ApJ}, 268, 368.
\bibitem[Fragos et~al.(2019)]{Fragos2019}
  Fragos,~T., Andrews,~J., \& co‑authors 2019, \emph{ApJ}, 883, L45.
\bibitem[Ostriker(1999)]{Ostriker1999}
  Ostriker,~E.\ 1999, \emph{ApJ}, 513, 252.
\bibitem[Peters(1964)]{Peters1964}
  Peters,~P.\ 1964, \emph{Phys.\ Rev.}, 136, B1224.
\bibitem[Ritter(1988)]{Ritter1988}
  Ritter,~H.\ 1988, \emph{A\&A}, 202, 93.
\end{thebibliography}

\end{document}
